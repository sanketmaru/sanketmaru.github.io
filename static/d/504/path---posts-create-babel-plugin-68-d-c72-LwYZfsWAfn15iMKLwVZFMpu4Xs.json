{"data":{"site":{"siteMetadata":{"author":{"name":"Sanket Maru","contacts":{"twitter":"sanketmaru"}},"disqusShortname":"sanketmaru","subtitle":"Javascript Developer.","title":"Blog by Sanket Maru","url":"http://sanketmaru.github.io"}},"markdownRemark":{"id":"cbbb75c3-a704-522b-82ca-391340c46a39","html":"<p><strong>First Babel Plugin</strong></p>\n<p>To write a babel plugin first you need to understand how babel plugins work. I will write down the things i required to write the plugin :-</p>\n<ol>\n<li>Go through the basics of <a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md\">Babel-handbook</a>.\nBasics will help to understand what is an AST, parsing, traversal of AST (Stages of Babel).\n </li>\n<li>Play with <a href=\"https://astexplorer.net\">Ast-explorer</a>\nThis will help to identify the different visitors of AST and which visitor you want to catch them to manipulate the paths.\n </li>\n<li>Setup a CRA (create-react-app) or a simple node project with a webpack config  <a href=\"https://createapp.dev/\">createapp.dev</a> is useful to get things done fast.\n </li>\n<li>\n<p>Debug, debug and debug…\nDebug other plugins code.\nSetup vscode to debug the babel plugins inside node_modules.\n \n<em>I will be covering a seperate blog on debbuging plugins and difficulties i faced developing a babel plugin</em>\n \nBelow is my vscode launch.json\n </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n<span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"request\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"launch\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Launch Program\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"program\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"${workspaceFolder}/scripts/build.js\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p> \n<strong>Enough of Reading material, lets make it work</strong></p>\n</li>\n</ol>\n<p>There are chances that some part of your code doesn’t get executed on a mobile device and functionality is completely hidden from the user. The code still resides in the bundle and is downloaded by the user. </p>\n<p>This babel plugin will remove the code developer has marked it as desktop and will never be included in the chunk. </p>\n<p>How do you do it ? Its Simple..</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Program</span><span class=\"token punctuation\">(</span>programPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      programPath<span class=\"token punctuation\">.</span><span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ClassMethod</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span>classMethodEnv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            path<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">JSXElement</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>openingElement<span class=\"token punctuation\">.</span>attributes<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>ele <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ele<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> jsxEnv<span class=\"token punctuation\">)</span>\n              path<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>We want to transform the AST such that every Class Method and JSXElement gets visited and removed if it matches the condition.\n<a href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/en/plugin-handbook.md#toc-visitors\">Babel: Visitors</a></p>\n<blockquote>\n<p>I have made the plugin use a Program(path) visitor, and then do a path.traverse for all the visitors. This is done to explicitly process the whole file at the first chance plugin gets. If this is not done then it doesn’t ensure ordering of plugins and your visitor might not get visited as it has been compiled to a different state by other plugins.</p>\n</blockquote>\n<p>Other option you can make your plugin work is to use a Class visitor and traverse for the class methods from there. </p>\n<p>Now that we are done with the <a href=\"https://github.com/sanketmaru/babel-plugin-mobile-optimizer-react/blob/master/index.js\">plugin</a>, we will be using it a react app to test it out.</p>\n<p><em>Published as a npm library <a href=\"https://www.npmjs.com/package/babel-plugin-mobile-optimizer-react\">here</a></em></p>\n<p><strong>Usage</strong></p>\n<p>Your React Component </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token function\">handleClick_mobile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Mobile Handle Click\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">handleClick_desktop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Desktop handle Click\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr data<span class=\"token operator\">-</span>mobile onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick_mobile<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>Mobile<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr data<span class=\"token operator\">-</span>desktop onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick_desktop<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>Web<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>will be transpiled to :-</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token function\">handleClick_mobile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Mobile Handle Click\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>table<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span>tr data<span class=\"token operator\">-</span>mobile onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleClick_mobile<span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n          <span class=\"token operator\">&lt;</span>td<span class=\"token operator\">></span>Mobile<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>td<span class=\"token operator\">></span>\n        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>tr<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>table<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Above, the plugin has removed the tr which has a name of <em>data-desktop</em> and class method ending with <em>_desktop</em></p>\n<p>We have passed the env vars to the plugin as </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">[</span>require<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'babel-plugin-mobile-optimizer-react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">\"JSX_ENV\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"data-desktop\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// remove jsx code matching with name as data-desktop</span>\n  <span class=\"token string\">\"CLASS_METHOD_ENV\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"_desktop\"</span> <span class=\"token comment\">// remove class method ending with _desktop</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>I hope this will help to write your own babel plugin. Complete code can be found on my github repo</p>\n<p>Plugin :- <a href=\"https://github.com/sanketmaru/babel-plugin-mobile-optimizer-react\">babel-plugin-mobile-optimizer-react</a>\nUsage in react app :- <a href=\"https://github.com/sanketmaru/react-labs\">react-labs</a></p>\n<p>In the next blog i will be mentioning about debugging the babel plugin and how you can setup vscode to debug it</p>","fields":{"tagSlugs":["/tag/babel/","/tag/react/","/tag/jsx/","/tag/mobile/","/tag/optimization/"]},"frontmatter":{"date":"2019-06-22T02:40:32.169Z","description":"I wrote my first babel plugin which reduces the size of the web app my removing class methods and jsx elements. The motivation is to remove class methods which are not executed when app is viewed in mobile view.","tags":["Babel","React","JSX","Mobile","Optimization"],"title":"Wrote my first babel plugin!( Its Simple )"}}},"pageContext":{"slug":"/posts/create-babel-plugin/"}}